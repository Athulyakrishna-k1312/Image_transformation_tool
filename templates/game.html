<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Catch Game - Unlock Image</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to right, #8360c3, #2ebf91);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      color: white;
    }
    canvas {
      background: #111;
      border: 4px solid #fff;
      border-radius: 12px;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      justify-content: space-between;
      width: 300px;
      font-size: 18px;
      font-weight: bold;
    }
    #endMessage {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      padding: 20px 30px;
      border-radius: 10px;
      text-align: center;
      display: none;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #ff4757;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #e84118;
    }
  </style>
</head>
<body>
  <div id="info">
    <span id="score">Score: 0</span>
    <span id="lives">Lives: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
  </div>
  <canvas id="gameCanvas" width="400" height="600"></canvas>

  <div id="endMessage">
    <h2 id="resultText"></h2>
    <button id="retryBtn">Retry</button>
    <button id="downloadBtn" style="display:none;">Download Image</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let basket = { x: canvas.width/2 - 40, y: canvas.height - 40, w: 80, h: 20, speed: 7 };
    let items = [];
    let score = 0;
    let lives = 3;
    let gameOver = false;

    let keys = {};
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);

    function spawnItem() {
      let size = 30;
      items.push({
        x: Math.random() * (canvas.width - size),
        y: -size,
        w: size,
        h: size,
        speed: 2 + Math.random() * 2
      });
    }

    function update() {
      if (gameOver) return;

      if (keys["ArrowLeft"]) basket.x -= basket.speed;
      if (keys["ArrowRight"]) basket.x += basket.speed;
      basket.x = Math.max(0, Math.min(canvas.width - basket.w, basket.x));

      for (let i = items.length - 1; i >= 0; i--) {
        let item = items[i];
        item.y += item.speed;

        if (item.y + item.h > basket.y &&
            item.x < basket.x + basket.w &&
            item.x + item.w > basket.x) {
          score++;
          items.splice(i, 1);
          document.getElementById("score").textContent = "Score: " + score;
          if (score >= 10) endGame(true);
        }
        else if (item.y > canvas.height) {
          lives--;
          items.splice(i, 1);
          updateLives();
          if (lives <= 0) endGame(false);
        }
      }
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#ffdd59";
      ctx.fillRect(basket.x, basket.y, basket.w, basket.h);

      ctx.fillStyle = "#74b9ff";
      items.forEach(item => {
        ctx.fillRect(item.x, item.y, item.w, item.h);
        ctx.fillStyle = "white";
        ctx.fillText("üì∑", item.x+6, item.y+22);
        ctx.fillStyle = "#74b9ff";
      });
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    function updateLives() {
      let hearts = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3-lives);
      document.getElementById("lives").textContent = "Lives: " + hearts;
    }

    function endGame(win) {
      gameOver = true;
      let msg = win ? "üéâ You Win! Image Unlocked!" : "‚ùå Game Over!";
      document.getElementById("resultText").textContent = msg;
      document.getElementById("endMessage").style.display = "block";

      if (win) {
        const btn = document.getElementById("downloadBtn");
        btn.style.display = "inline-block";
        btn.onclick = () => {
          window.location.href = "/download_image_unlocked/{{ image_id }}";
        };
      }
    }

    document.getElementById("retryBtn").onclick = () => {
      score = 0; lives = 3; gameOver = false;
      items = [];
      updateLives();
      document.getElementById("score").textContent = "Score: 0";
      document.getElementById("endMessage").style.display = "none";
    };

    setInterval(spawnItem, 1200);
    loop();
  </script>
  {% if error %}
  <script>
    alert("{{ error }}");
  </script>
{% endif %}

</body>
</html>
